<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>willeponken</title>
    <base href="https://willeponken.me">
    <link rel="canonical" href="https://willeponken.me/posts/gentoo_with_dm-crypt_luks/">
    <link href="" rel="alternate" type="application/rss+xml" title="willeponken" />
    <link rel="shortcut icon" type="image/png" href="https://willeponken.me/favicon.png">
    <link rel="stylesheet" href="https://willeponken.me/css/main.css" />
  </head>
  <body>
    <header>
      <a href="https://willeponken.me/">
        <h1>willeponken</h1>
        <small>William Wennerstr√∂m</small>
      </a>
      <navbar>
        <ul>
          <li><a href="https://willeponken.me/posts">Posts</a></li>
          <li><a href="https://github.com/willeponken">GitHub</a></li>
          <li><a href="https://gitlab.com/u/willeponken">GitLab</a></li>
          <li><a href="http://[fc3b:f1c1:b985:6dab:fb9:742:bb07:a7ba]">Hyperboria</a></li>
        </ul>
      </navbar>
    </header>

<article class="clearfix">
  <h1 class="posttitle">Gentoo with DM-Crypt LUKS and EFI (Work In Progress)</h1>
  <small>Sat May 21, 2016 - 
    
    <a href="https://willeponken.me/categories/gentoo">gentoo</a> 
    
    <a href="https://willeponken.me/categories/os">os</a> 
    
    <a href="https://willeponken.me/categories/encryption">encryption</a> 
    
  </small>
  <hr />
  <section>
    

<p>This article serves as somekind of meta instruction for installing Gentoo with DM-Crypt LUKS.</p>

<p>The guide is heavily based upon <em>Sakaki&rsquo;s EFI Install Guide</em>: <a href="https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide">https://wiki.gentoo.org/wiki/Sakaki%27s_EFI_Install_Guide</a></p>

<p>If this is your first time installing Gentoo it&rsquo;s probably a better idea to follow <em>Sakaki&rsquo;s EFI Install Guide</em>, or follow <em>Gentoo&rsquo;s Handbook</em>: https:/wiki.gentoo.org/wiki/Handbook:AMD64/Full/Installation</p>

<h2 id="burn-minimal-installation-cd-to-usb">Burn Minimal Installation CD to USB</h2>

<p>Download the Minimal Installation CD from: <a href="https://www.gentoo.org/downloads/">https://www.gentoo.org/downloads/</a></p>

<p>Write the ISO to the USB drive using DD:</p>

<pre><code>dd if=/path/to/image.iso of=/dev/sdX bs=8192k
</code></pre>

<h2 id="boot-and-connect-to-a-network">Boot and connect to a network</h2>

<p>Either connect a network cable, or connect to a WLAN using:</p>

<pre><code># Add AP w/ passphrase to config
wpa_passphrase &quot;ESSID&quot; &gt; /etc/wpa.conf
&lt;then type your WiFi access point passphrase (without quotes) and press Enter&gt;

# Fix permissions
chmod -v 600 /etc/wpa.conf

# Check for available WLAN interface
ip a

# Connect using WLAN interface
wpa_supplicant -Dnl80211,wext -i&lt;interface&gt; -c/etc/wpa.conf -B 
</code></pre>

<h2 id="create-gpt-partition-on-main-storage">Create GPT partition on main storage</h2>

<p>Find the main storage drive using:</p>

<pre><code>lsblk
</code></pre>

<p>Run <code>parted</code> to create the GPT partition:</p>

<pre><code>parted -a optimal /dev/sdX
</code></pre>

<p>Inside parted issue:</p>

<pre><code>(parted) unit mib
(parted) mklabel gpt
(parted) mkpart grub 1 3
(parted) set 1 bios_grub on
(parted) mkpart boot fat32 3 515
(parted) set 2 BOOT on
(parted) mkpart lvm 515 -1
(parted) set 3 lvm on
(parted) print
(parted) quit
</code></pre>

<p>Make sure everything is correct:</p>

<pre><code>lsblk
</code></pre>

<p>Overwrite the partitions with pseudo-random data (if you&rsquo;re paranoid):</p>

<pre><code>dd if=/dev/urandom of=/dev/sdX{1..3} bs=1M
</code></pre>

<h2 id="format-main-parition-with-luks">Format main parition with LUKS</h2>

<p>Let <code>cryptsetup</code> format <code>/dev/sdX3</code> as a LUKS partition:</p>

<pre><code>cryptsetup --key-size 512 --hash sha512 luksFormat /dev/sdX3
</code></pre>

<p>Verify everything went well:</p>

<pre><code>cryptsetup luksDump /dev/sdX3
</code></pre>

<h2 id="setup-lvm-on-main-luks-partition">Setup LVM on main LUKS partition</h2>

<p>Open the LUKS volume:</p>

<pre><code>cryptsetup luksOpen /dev/sdX3 storage
</code></pre>

<p>Create LVM physical volume (PV):</p>

<pre><code>pvcreate /dev/mapper/storage
</code></pre>

<p>Create LVM volume group (VG):</p>

<pre><code>vgcreate main /dev/mapper/storage
</code></pre>

<p>Check the size of RAM:</p>

<pre><code>grep MemTotal /proc/meminfo
</code></pre>

<p>Create LVM logical volume (LV) for swap:</p>

<pre><code>lvcreate --size &lt;size-of-ram+2&gt;G --name swap main
</code></pre>

<p>Create LVM logical volume (LV) for root:</p>

<pre><code>lvcreate --size 100%FREE --name root main
</code></pre>

<p>Make sure everything is setup correct:</p>

<pre><code>pvdisplay
vgdisplay
lvdisplay
ls /dev/mapper
</code></pre>

<h2 id="format-and-mount-the-logical-volumes-lvs">Format and mount the logical volumes (LVs):</h2>

<p>Format swap:</p>

<pre><code>mkswap -L &quot;swap&quot; /dev/mapper/main-swap
</code></pre>

<p>Format root:</p>

<pre><code>mkfs.ext4 -L &quot;root&quot; /dev/mapper/main-root
</code></pre>

<p>Format efi/boot:</p>

<pre><code>mkfs.vfat -F32 /dev/sdX2
</code></pre>

<p>Activate swap:</p>

<pre><code>swapon /dev/mapper/main-swap
</code></pre>

<p>Mount root directory at pre-existing <code>/mnt/gentoo</code> mountpoint:</p>

<pre><code>mount -t ext4 /dev/mapper/main-root /mnt/gentoo
</code></pre>

<p>Create needed directories in root:</p>

<pre><code>mkdir /mnt/gentoo/{home,boot,boot/efi}
</code></pre>

<p>Mount home directory:</p>

<pre><code>mount -t ext4 /dev/mapper/main-home /mnt/gentoo/home
</code></pre>

<p>Take note of the PARTUUID for the main partition:</p>

<pre><code>blkid /dev/sdX3
</code></pre>

<h2 id="check-date-and-time">Check date and time</h2>

<p>Make sure the time is correct:</p>

<pre><code>date
</code></pre>

<h2 id="fetch-and-unpack-the-gentoo-stage-3-tarball">Fetch and unpack the Gentoo Stage 3 Tarball:</h2>

<p>Change to the root mountpoint:</p>

<pre><code>cd /mnt/gentoo
</code></pre>

<p>Download the latest Stage 3 files:</p>

<pre><code>links http://distfiles.gentoo.org/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-YYYYMMDD.tar.bz2
</code></pre>

<p>Look for (find the files where YYYYMMDD is the latest date):</p>

<pre><code>/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-YYYYMMDD.tar.bz2
/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-YYYYMMDD.tar.bz2.CONTENTS
/releases/amd64/autobuilds/current-stage3-amd64/stage3-amd64-YYYYMMDD.tar.bz2.DIGESTS.asc
</code></pre>

<p>Retrieve the public key:</p>

<pre><code>gpg --recv-keys 0x9E6438C817072058
</code></pre>

<p>Verify the cryptographic signature:</p>

<pre><code>gpg --verify stage3-amd64-*.DIGESTS.asc
</code></pre>

<p>Check the digests:</p>

<pre><code>awk '/SHA512 HASH/{getline;print}' stage3-amd64-*.DIGESTS.asc | sha512sum -- check
</code></pre>

<p>Double check you&rsquo;re in the <code>/mnt/gentoo</code> directory, then issue:</p>

<pre><code>tar xvjpf stage3-amd64-*.tar.bz2
</code></pre>

<p>Remove the Stage 3 files:</p>

<pre><code>rm stage3-amd64-*
</code></pre>

<p>Return home:</p>

<pre><code>cd
</code></pre>

<h2 id="setup-portage">Setup Portage</h2>

<p>Edit the <code>/mnt/gentoo/etc/portage/make.conf</code> file (modify for your computer):</p>

<pre><code># The holy USE
USE=&quot;device-mapper&quot;

# C and C++ compiler options for GCC.
CFLAGS=&quot;-march=native -O2 -pipe&quot;
CXXFLAGS=&quot;${CFLAGS}&quot;
MAKEOPTS=&quot;-j4&quot; # 4 threads per job
EMERGE_DEFAULT_OPTS=&quot;--jobs 2 --load-average 7.2&quot; # 2 parallel jobs, at 8*0.9 load (90 % load on all cores)
CPU_FLAGS_X86=&quot;aes avx f16c mmx mmxext pclmul popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3&quot; # check w/ cpuid2cpuflags

# Only free software, please.
ACCEPT_LICENSE=&quot;-* @FREE CC-Sampling-Plus-1.0&quot;

# WARNING: Changing your CHOST is not something that should be done lightly.
# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.
CHOST=&quot;x86_64-pc-linux-gnu&quot;

# Use the 'stable' branch.
ACCEPT_KEYWORDS=&quot;amd64&quot;

# Additional USE flags in addition to those specified by the current profile.
USE=&quot;${CPU_FLAGS_X86}&quot;

# Important Portage directories.
PORTDIR=&quot;/usr/portage&quot;
DISTDIR=&quot;${PORTDIR}/distfiles&quot;
PKGDIR=&quot;${PORTDIR}/packages&quot;

# Turn on logging - see http://gentoo-en.vfose.ru/wiki/Gentoo_maintenance.
PORTAGE_ELOG_CLASSES=&quot;info warn error log qa&quot;
PORTAGE_ELOG_SYSTEM=&quot;save&quot;
# Logs go to /var/log/portage/elog by default - view them with elogviewer.

# Settings for X11 (make sure these are correct for your hardware).
VIDEO_CARDS=&quot;intel i965&quot;
INPUT_DEVICES=&quot;evdev synaptics&quot;

# Dracut (initramfs)
DRACUT_MODULES=&quot;crypt lvm&quot;
</code></pre>

<h2 id="prepare-and-enter-chroot">Prepare and enter <code>chroot</code></h2>

<p>Select the correct mirror for your location:</p>

<pre><code>mirrorselect -i -o &gt;&gt; /mnt/gentoo/etc/portage/make.conf
</code></pre>

<p>Setup <code>/mnt/gentoo/etc/portage/repos.conf</code> directory:</p>

<pre><code>mkdir -p /mnt/gentoo/etc/portage/repos.conf
cp /mnt/gentoo/usr/share/portage/config/repos.conf /mnt/gentoo/etc/portage/repos.conf/gentoo.conf
</code></pre>

<p>Copy resolv.conf so DNS works in <code>chroot</code>:</p>

<pre><code>cp -L /etc/resolv.conf /mnt/gentoo/etc/
</code></pre>

<p>If we&rsquo;re using WLAN, also run:</p>

<pre><code>cp /etc/wpa.conf /mnt/gentoo/etc/
</code></pre>

<p>Mount <code>/proc</code>, <code>/sys</code> and <code>/dev</code>:</p>

<pre><code>mount -t proc none /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/dev
</code></pre>

<p>Enter <code>chroot</code>:</p>

<pre><code>chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1=&quot;(chroot) $PS1&quot;
</code></pre>

<h2 id="install-the-portage-tree">Install the Portage Tree</h2>

<p>Install the latest Portage repository tree snapshot (it&rsquo;ll create all directories it&rsquo;s complaining about):</p>

<pre><code>(chroot) emerge-webrsync
</code></pre>

<p>Update the Portage tree:</p>

<pre><code>(chroot) emerge --sync
</code></pre>

<p>Make sure the Portage package is up-to-date:</p>

<pre><code>(chroot) emerge --ask --verbose --oneshot portage
</code></pre>

<p>Check which baseline profile to use:</p>

<pre><code>(chroot) eselect profile list
</code></pre>

<p>Select the correct profile (change <code>1</code> to the correct one):</p>

<pre><code>(chroot) eselect profile set 1
</code></pre>

<p>Make a sanity check of the profile, <code>make.conf</code>, enviroment etc.:</p>

<pre><code>(chroot) emerge --info
</code></pre>

<h2 id="setup-timezone-and-locale">Setup timezone and locale</h2>

<p>Check for your timezone:</p>

<pre><code>(chroot) ls /usr/share/zoneinfo
</code></pre>

<p>Set the timezone:</p>

<pre><code>(chroot) echo &quot;Europe/Stockholm&quot; &gt; /etc/timezone
</code></pre>

<p>Reconfigure the <code>sys-libs/timezone-data</code> package so it picks up the new timezone:</p>

<pre><code>(chroot) emerge --config sys-libs/timezone-data
</code></pre>

<p>Set the locale by uncommenting the correct ones in <code>/etc/locale.gen</code>, in my case:</p>

<pre><code>en_US.UTF-8 UTF-8
</code></pre>

<p>Generate the new locales:</p>

<pre><code>(chroot) locale-gen
</code></pre>

<p>Find the number for the locale:</p>

<pre><code>(chroot) eselect locale list
</code></pre>

<p>Set the locale to the <code>C</code> locale (we&rsquo;ll change to the actual later):</p>

<pre><code>(chroot) eselect locale set 1
</code></pre>

<p>Reload the enviroment:</p>

<pre><code>(chroot) env-update &amp;&amp; source /etc/profile &amp;&amp; export PS1=&quot;(chroot) $PS1&quot;
</code></pre>

<p>Find the correct key map:</p>

<pre><code>(chroot) ls /usr/share/keymaps/i386/qwerty
</code></pre>

<p>Choose the correct one (strip out<code>.map.gz</code>) and edit <code>/etc/conf.d/keymaps</code>:</p>

<pre><code>keymap=&quot;sv-latin1&quot;
</code></pre>

<h2 id="some-minor-fixes-optional">Some minor fixes (optional)</h2>

<p>If you want to use LibreSSL instead of OpenSSL follow the guide here:
<a href="https://wiki.gentoo.org/wiki/Project:LibreSSL">https://wiki.gentoo.org/wiki/Project:LibreSSL</a></p>

<h2 id="create-directories-for-package-use-package-mask-etc">Create directories for package.use, package.mask, etc.:</h2>

<pre><code>(chroot) mkdir -p -v /etc/portage/package.use
(chroot) touch /etc/portage/package.use/zzz_via_autounmask
(chroot) mkdir -p -v /etc/portage/package.mask
(chroot) mkdir -p -v /etc/portage/package.unmask
(chroot) touch /etc/portage/package.unmask/zzz_via_autounmask
(chroot) mkdir -p -v /etc/portage/package.accept_keywords
(chroot) touch /etc/portage/package.accept_keywords/zzz_via_autounmask
</code></pre>

<h2 id="finally-make-sure-system-is-up-to-date">Finally, make sure system is up-to-date</h2>

<p>Update <code>@world</code>:</p>

<pre><code>(chroot) emerge --ask --verbose --deep --with-bdeps=y --newuse --update @world
</code></pre>

<p>Make sure everything is configured correctly:</p>

<pre><code>(chroot) dispatch-conf
</code></pre>

<h2 id="build-the-linux-kernel">Build the Linux kernel</h2>

<p>Permit licenses needed to build kernel:</p>

<pre><code>(chroot) mkdir -p -v /etc/portage/package.license
(chroot) touch /etc/portage/package.license/zzz_via_autounmask
(chroot) echo &quot;sys-kernel/gentoo-sources freedist&quot; &gt;&gt; /etc/portage/package.license/gentoo-sources
(chroot) echo &quot;sys-kernel/linux-firmware freedist&quot; &gt;&gt; /etc/portage/package.license/linux-firmware
</code></pre>

<p>Fetch the kernel sources and firmware:</p>

<pre><code>(chroot) emerge --ask --verbose sys-kernel/gentoo-sources
(chroot) emerge --ask --verbose sys-kernel/linux-firmware
</code></pre>

<p>Make sure <code>/usr/src/linux</code> points to current kernel version:</p>

<pre><code>(chroot) readlink -v /usr/src/linux
(chroot) eselect kernel list
</code></pre>

<p>Configure the kernel:</p>

<pre><code>Gentoo Linux &gt; Support for init systems, system and service managers &gt; [*] systemd
General setup &gt; [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support
Enable the block layer &gt; Partition Types &gt; [*]   EFI GUID Partition support
Processor type and features &gt; [*] EFI runtime service support
Device Drivers &gt; Generic Driver Options &gt; () path to uevent helper
Device Drivers &gt; Multiple devices driver support (RAID and LVM) &gt; &lt;*&gt;   Device mapper support &gt; &lt;*&gt;     Crypt target support
Device Drivers &gt; Multiple devices driver support (RAID and LVM) &gt; &lt;*&gt;   Device mapper support &gt; &lt;*&gt;     Mirror target
Device Drivers &gt; Graphics support &gt; Support for frame buffer devices &gt; [*]   Enable firmware EDID
Device Drivers &gt; Graphics support &gt; Support for frame buffer devices &gt; [*]   EFI-based Framebuffer Support
Device Drivers &gt; Graphics support &gt; Console display driver support &gt; &lt;*&gt; Framebuffer Console support
Firmware Drivers &gt; EFI (Extensible Firmware Interface)  Support &gt; &lt;*&gt; EFI Variable Support via sysfs

</code></pre>

<p>Build and install the kernel:</p>

<pre><code>(chroot) make &amp;&amp; make modules_install &amp;&amp; make install

</code></pre>

<p>Prepare for initramfs:</p>

<pre><code>echo &quot;sys-kernel/dracut&quot; &gt;&gt; /etc/portage/package.keywords/dracut
emerge -av sys-kernel/dracut
echo 'GRUB_CMDLINE_LINUX=&quot;rd.lvm.vg=main&quot;' &gt;&gt; /etc/default/grub
</code></pre>

<p>TBC</p>

  </section>
  <section>
    <p>
      <small>
  <em>Categories: </em>
  
  <a href="https://willeponken.me/categories/gentoo">gentoo</a>
  
  <a href="https://willeponken.me/categories/os">os</a>
  
  <a href="https://willeponken.me/categories/encryption">encryption</a>
  
</small><br />

      <small>
  
  
</small>

    </p>
  </section>
</article>
    <footer>
      <address>
        <small>
          <strong>E-mail:</strong> {myfirstname}@willeponken.me<br />
          <strong>Public key:</strong> <a href="https://keybase.io/willeponken/key.asc">keybase.io/willeponken/key.asc</a><br />
        </small>
      </address>
    </footer>
  </body>

</html>

